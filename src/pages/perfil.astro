---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/login');
}

const { data: user } = await supabase
  .from('users')
  .select('*')
  .eq('id', session.user.id)
  .single();
---

<Layout title="Mi Perfil">
  <div class="max-w-2xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8">Mi Perfil</h1>

    <div class="card mb-6">
      <h2 class="text-2xl font-bold mb-4">Información Personal</h2>
      
      <form id="profile-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Nombre Completo</label>
          <input
            type="text"
            id="full-name"
            value={user?.full_name || ''}
            class="input"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Email</label>
          <input
            type="email"
            value={session.user.email}
            disabled
            class="input bg-gray-100"
          />
          <p class="text-sm text-gray-600 mt-1">El email no puede ser modificado</p>
        </div>

        <div id="success-message" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-lg"></div>
        <div id="error-message" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>

        <button type="submit" class="btn btn-primary">
          Guardar Cambios
        </button>
      </form>
    </div>

    <div class="card">
      <h2 class="text-2xl font-bold mb-4">Cambiar Contraseña</h2>
      
      <form id="password-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Nueva Contraseña</label>
          <input
            type="password"
            id="new-password"
            minlength="6"
            placeholder="Mínimo 6 caracteres"
            class="input"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Confirmar Contraseña</label>
          <input
            type="password"
            id="confirm-password"
            placeholder="Repite tu contraseña"
            class="input"
          />
        </div>

        <div id="password-success" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-lg"></div>
        <div id="password-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>

        <button type="submit" class="btn btn-secondary">
          Actualizar Contraseña
        </button>
      </form>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    // Actualizar perfil
    const profileForm = document.getElementById('profile-form');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fullName = (document.getElementById('full-name') as HTMLInputElement).value;
      const { data: { session } } = await supabase.auth.getSession();

      try {
        const { error } = await supabase
          .from('users')
          .update({ full_name: fullName })
          .eq('id', session!.user.id);

        if (error) throw error;

        successMessage!.textContent = 'Perfil actualizado correctamente';
        successMessage!.classList.remove('hidden');
        errorMessage!.classList.add('hidden');

        setTimeout(() => {
          successMessage!.classList.add('hidden');
        }, 3000);
      } catch (error: any) {
        errorMessage!.textContent = error.message || 'Error al actualizar el perfil';
        errorMessage!.classList.remove('hidden');
        successMessage!.classList.add('hidden');
      }
    });

    // Cambiar contraseña
    const passwordForm = document.getElementById('password-form');
    const passwordSuccess = document.getElementById('password-success');
    const passwordError = document.getElementById('password-error');

    passwordForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = (document.getElementById('new-password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;

      if (newPassword !== confirmPassword) {
        passwordError!.textContent = 'Las contraseñas no coinciden';
        passwordError!.classList.remove('hidden');
        passwordSuccess!.classList.add('hidden');
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;

        passwordSuccess!.textContent = 'Contraseña actualizada correctamente';
        passwordSuccess!.classList.remove('hidden');
        passwordError!.classList.add('hidden');

        (document.getElementById('new-password') as HTMLInputElement).value = '';
        (document.getElementById('confirm-password') as HTMLInputElement).value = '';

        setTimeout(() => {
          passwordSuccess!.classList.add('hidden');
        }, 3000);
      } catch (error: any) {
        passwordError!.textContent = error.message || 'Error al actualizar la contraseña';
        passwordError!.classList.remove('hidden');
        passwordSuccess!.classList.add('hidden');
      }
    });
  </script>
</Layout>
