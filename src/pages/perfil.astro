---
import Layout from '../layouts/Layout.astro';
import { createServerClient } from '../lib/supabase';

const supabase = createServerClient(Astro.cookies);
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/login');
}

const { data: user } = await supabase
  .from('users')
  .select('*')
  .eq('id', session.user.id)
  .single();

// Obtener estad√≠sticas del usuario
const { count: totalOrders } = await supabase
  .from('orders')
  .select('*', { count: 'exact', head: true })
  .eq('user_id', session.user.id);

const { data: totalSpentData } = await supabase
  .from('orders')
  .select('total')
  .eq('user_id', session.user.id)
  .in('status', ['pagado', 'enviado', 'entregado']);

const totalSpent = totalSpentData?.reduce((sum, order) => sum + Number(order.total), 0) || 0;
---

<Layout title="Mi Perfil">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
      
      <!-- Header con avatar -->
      <div class="bg-white rounded-2xl shadow-sm p-8 mb-6">
        <div class="flex items-center gap-6">
          <div class="w-24 h-24 bg-purple-100 rounded-full flex items-center justify-center">
            <span class="text-4xl">üë§</span>
          </div>
          <div class="flex-1">
            <h1 class="text-3xl font-bold text-gray-800">{user?.full_name || 'Usuario'}</h1>
            <p class="text-gray-600">{session.user.email}</p>
            <p class="text-sm text-gray-500 mt-1">Miembro desde {new Date(user?.created_at || Date.now()).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</p>
          </div>
          <div class="hidden md:flex gap-8">
            <div class="text-center">
              <p class="text-3xl font-bold text-purple-600">{totalOrders || 0}</p>
              <p class="text-sm text-gray-500">Pedidos</p>
            </div>
            <div class="text-center">
              <p class="text-3xl font-bold text-green-600">{totalSpent.toFixed(0)}‚Ç¨</p>
              <p class="text-sm text-gray-500">Total gastado</p>
            </div>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <!-- Informaci√≥n Personal -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
          <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
            <span>üë§</span> Informaci√≥n Personal
          </h2>
          
          <form id="profile-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
              <input
                type="text"
                id="full-name"
                value={user?.full_name || ''}
                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                placeholder="Tu nombre"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input
                type="email"
                value={session.user.email}
                disabled
                class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-500"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
              <input
                type="tel"
                id="phone"
                value={user?.phone || ''}
                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                placeholder="+34 600 000 000"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n de env√≠o</label>
              <textarea
                id="address"
                rows="3"
                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-none"
                placeholder="Calle, n√∫mero, piso, ciudad, CP"
              >{user?.address || ''}</textarea>
            </div>

            <div id="profile-message" class="hidden p-3 rounded-lg text-sm"></div>

            <button type="submit" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors">
              Guardar Cambios
            </button>
          </form>
        </div>

        <!-- Seguridad -->
        <div class="space-y-6">
          <!-- Cambiar Contrase√±a -->
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
              <span>üîê</span> Cambiar Contrase√±a
            </h2>
            
            <form id="password-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contrase√±a</label>
                <input
                  type="password"
                  id="new-password"
                  minlength="6"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="M√≠nimo 6 caracteres"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contrase√±a</label>
                <input
                  type="password"
                  id="confirm-password"
                  class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Repite la contrase√±a"
                />
              </div>

              <div id="password-message" class="hidden p-3 rounded-lg text-sm"></div>

              <button type="submit" class="w-full py-3 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-colors">
                Actualizar Contrase√±a
              </button>
            </form>
          </div>

          <!-- Accesos R√°pidos -->
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
              <span>‚ö°</span> Accesos R√°pidos
            </h2>
            <div class="space-y-2">
              <a href="/mis-pedidos" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <span class="text-2xl">üì¶</span>
                <div>
                  <p class="font-medium">Mis Pedidos</p>
                  <p class="text-sm text-gray-500">Ver historial de compras</p>
                </div>
              </a>
              <a href="/favoritos" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                <span class="text-2xl">‚ù§Ô∏è</span>
                <div>
                  <p class="font-medium">Favoritos</p>
                  <p class="text-sm text-gray-500">Productos guardados</p>
                </div>
              </a>
              <button id="logout-btn" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-50 text-red-600 transition-colors">
                <span class="text-2xl">üö™</span>
                <div class="text-left">
                  <p class="font-medium">Cerrar Sesi√≥n</p>
                  <p class="text-sm text-red-400">Salir de tu cuenta</p>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    // Actualizar perfil
    const profileForm = document.getElementById('profile-form');
    const profileMessage = document.getElementById('profile-message');

    profileForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fullName = (document.getElementById('full-name') as HTMLInputElement).value;
      const phone = (document.getElementById('phone') as HTMLInputElement).value;
      const address = (document.getElementById('address') as HTMLTextAreaElement).value;
      
      const { data: { session } } = await supabase.auth.getSession();

      try {
        const { error } = await supabase
          .from('users')
          .update({ full_name: fullName, phone, address })
          .eq('id', session!.user.id);

        if (error) throw error;

        profileMessage!.textContent = '‚úÖ Perfil actualizado correctamente';
        profileMessage!.className = 'p-3 rounded-lg text-sm bg-green-100 text-green-700';
        profileMessage!.classList.remove('hidden');

        setTimeout(() => profileMessage!.classList.add('hidden'), 3000);
      } catch (error: any) {
        profileMessage!.textContent = '‚ùå ' + (error.message || 'Error al actualizar');
        profileMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        profileMessage!.classList.remove('hidden');
      }
    });

    // Cambiar contrase√±a
    const passwordForm = document.getElementById('password-form');
    const passwordMessage = document.getElementById('password-message');

    passwordForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = (document.getElementById('new-password') as HTMLInputElement).value;
      const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;

      if (newPassword.length < 6) {
        passwordMessage!.textContent = '‚ùå La contrase√±a debe tener al menos 6 caracteres';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
        return;
      }

      if (newPassword !== confirmPassword) {
        passwordMessage!.textContent = '‚ùå Las contrase√±as no coinciden';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) throw error;

        passwordMessage!.textContent = '‚úÖ Contrase√±a actualizada correctamente';
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-green-100 text-green-700';
        passwordMessage!.classList.remove('hidden');

        (document.getElementById('new-password') as HTMLInputElement).value = '';
        (document.getElementById('confirm-password') as HTMLInputElement).value = '';

        setTimeout(() => passwordMessage!.classList.add('hidden'), 3000);
      } catch (error: any) {
        passwordMessage!.textContent = '‚ùå ' + (error.message || 'Error al actualizar');
        passwordMessage!.className = 'p-3 rounded-lg text-sm bg-red-100 text-red-700';
        passwordMessage!.classList.remove('hidden');
      }
    });

    // Cerrar sesi√≥n
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      // Borrar cookies de sesi√≥n
      document.cookie = 'sb-access-token=; path=/; max-age=0';
      document.cookie = 'sb-refresh-token=; path=/; max-age=0';
      window.location.href = '/';
    });
  </script>
</Layout>
