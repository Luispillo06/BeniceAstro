---
import Layout from '../../../layouts/Layout.astro';
import { createServerClient } from '../../../lib/supabase';

// Proteger ruta - solo admins
const supabase = createServerClient(Astro.cookies);
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/login');
}

const { data: userData } = await supabase
  .from('users')
  .select('role')
  .eq('id', session.user.id)
  .single();

if (!userData || userData.role !== 'admin') {
  return Astro.redirect('/');
}

// Obtener productos
const { data: products } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false });
---

<Layout title="Gesti√≥n de Productos - Admin">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Gesti√≥n de Productos</h1>
        <p class="text-gray-600 mt-1">Administra el cat√°logo de tu tienda</p>
      </div>
      <div class="flex gap-3">
        <a href="/admin" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">
          ‚Üê Volver al Dashboard
        </a>
        <a href="/admin/productos/nuevo" class="btn btn-primary">
          + Nuevo Producto
        </a>
      </div>
    </div>

    <!-- Filtros r√°pidos -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="flex flex-wrap gap-4 items-center">
        <div>
          <label class="text-sm font-medium text-gray-700">Buscar:</label>
          <input type="text" id="search-filter" placeholder="Nombre del producto..." 
            class="ml-2 input w-64" />
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Categor√≠a:</label>
          <select id="category-filter" class="ml-2 input">
            <option value="">Todas</option>
            <option value="alimentacion">Alimentaci√≥n</option>
            <option value="higiene">Higiene</option>
            <option value="salud">Salud</option>
            <option value="accesorios">Accesorios</option>
            <option value="juguetes">Juguetes</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Especie:</label>
          <select id="animal-filter" class="ml-2 input">
            <option value="">Todas</option>
            <option value="perro">Perro</option>
            <option value="gato">Gato</option>
            <option value="otros">Otros</option>
          </select>
        </div>
        <div class="ml-auto">
          <span class="text-sm text-gray-600">
            Total: <strong id="product-count">{products?.length || 0}</strong> productos
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla de productos -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Producto
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Categor√≠a
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Precio
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Stock
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Estado
            </th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
              Acciones
            </th>
          </tr>
        </thead>
        <tbody id="products-table" class="bg-white divide-y divide-gray-200">
          {products && products.map((product: any) => (
            <tr class="product-row hover:bg-gray-50" 
                data-name={product.name.toLowerCase()} 
                data-category={product.category}
                data-animal={product.animal_type}>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-12 w-12">
                    <img class="h-12 w-12 rounded-lg object-cover" 
                         src={product.image_url || 'https://via.placeholder.com/100?text=Sin+imagen'} 
                         alt={product.name} />
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">{product.name}</div>
                    <div class="text-sm text-gray-500">{product.animal_type} ‚Ä¢ {product.size}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                  {product.category}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900 font-medium">{product.price}‚Ç¨</div>
                {product.on_sale && product.sale_price && (
                  <div class="text-xs text-green-600">Oferta: {product.sale_price}‚Ç¨</div>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class={`px-2 py-1 text-xs font-medium rounded ${
                  product.stock > 10 ? 'bg-green-100 text-green-800' : 
                  product.stock > 0 ? 'bg-yellow-100 text-yellow-800' : 
                  'bg-red-100 text-red-800'
                }`}>
                  {product.stock} uds
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {product.on_sale ? (
                  <span class="px-2 py-1 text-xs font-medium rounded bg-orange-100 text-orange-800">
                    üî• Oferta
                  </span>
                ) : (
                  <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-600">
                    Normal
                  </span>
                )}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href={`/admin/productos/${product.id}`} 
                   class="text-purple-700 hover:text-purple-900 mr-4">
                  ‚úèÔ∏è Editar
                </a>
                <button class="text-red-600 hover:text-red-900 delete-btn" 
                        data-id={product.id} 
                        data-name={product.name}>
                  üóëÔ∏è Eliminar
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      
      {(!products || products.length === 0) && (
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">No hay productos registrados</p>
          <a href="/admin/productos/nuevo" class="btn btn-primary mt-4">
            Crear primer producto
          </a>
        </div>
      )}
    </div>
  </div>

  <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
  <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
      <p class="text-gray-600 mb-2">¬øEst√°s seguro de que quieres eliminar el producto:</p>
      <p class="font-bold text-gray-800 mb-4" id="delete-product-name"></p>
      <p class="text-sm text-red-600 mb-6">Esta acci√≥n no se puede deshacer.</p>
      <div class="flex gap-3 justify-end">
        <button id="cancel-delete" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">
          Cancelar
        </button>
        <button id="confirm-delete" class="btn bg-red-600 text-white hover:bg-red-700">
          Eliminar
        </button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../../../lib/supabase';

    // Filtros
    const searchFilter = document.getElementById('search-filter') as HTMLInputElement;
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const animalFilter = document.getElementById('animal-filter') as HTMLSelectElement;
    const productCount = document.getElementById('product-count');
    const rows = document.querySelectorAll('.product-row');

    function filterProducts() {
      const search = searchFilter.value.toLowerCase();
      const category = categoryFilter.value;
      const animal = animalFilter.value;
      let visible = 0;

      rows.forEach(row => {
        const name = row.getAttribute('data-name') || '';
        const rowCategory = row.getAttribute('data-category') || '';
        const rowAnimal = row.getAttribute('data-animal') || '';

        const matchSearch = name.includes(search);
        const matchCategory = !category || rowCategory === category;
        const matchAnimal = !animal || rowAnimal === animal;

        if (matchSearch && matchCategory && matchAnimal) {
          (row as HTMLElement).style.display = '';
          visible++;
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });

      if (productCount) productCount.textContent = visible.toString();
    }

    searchFilter?.addEventListener('input', filterProducts);
    categoryFilter?.addEventListener('change', filterProducts);
    animalFilter?.addEventListener('change', filterProducts);

    // Modal de eliminaci√≥n
    const deleteModal = document.getElementById('delete-modal');
    const deleteProductName = document.getElementById('delete-product-name');
    const cancelDelete = document.getElementById('cancel-delete');
    const confirmDelete = document.getElementById('confirm-delete');
    let productToDelete: string | null = null;

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLElement;
        productToDelete = target.dataset.id || null;
        const name = target.dataset.name || '';
        
        if (deleteProductName) deleteProductName.textContent = name;
        deleteModal?.classList.remove('hidden');
      });
    });

    cancelDelete?.addEventListener('click', () => {
      deleteModal?.classList.add('hidden');
      productToDelete = null;
    });

    confirmDelete?.addEventListener('click', async () => {
      if (!productToDelete) return;

      try {
        const { data: { session } } = await supabase.auth.getSession();
        
        const response = await fetch(`/api/admin/products?id=${productToDelete}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${session?.access_token}`
          }
        });

        if (response.ok) {
          // Recargar p√°gina para ver cambios
          window.location.reload();
        } else {
          const result = await response.json();
          alert(result.error || 'Error al eliminar producto');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar producto');
      }

      deleteModal?.classList.add('hidden');
      productToDelete = null;
    });
  </script>
</Layout>
