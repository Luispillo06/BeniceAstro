---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Carrito de Compras">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8">Carrito de Compras</h1>

    <div id="empty-cart" class="hidden text-center py-12">
      <div class="text-6xl mb-4">üõí</div>
      <p class="text-xl text-gray-600 mb-4">Tu carrito est√° vac√≠o</p>
      <a href="/productos" class="btn btn-primary">
        Ver Productos
      </a>
    </div>

    <div id="cart-content">
      <div class="space-y-4 mb-8" id="cart-items"></div>

      <!-- C√≥digo Promocional -->
      <div class="card mb-8">
        <h3 class="font-bold mb-4">¬øTienes un c√≥digo promocional?</h3>
        <div class="flex gap-2">
          <input
            type="text"
            id="promo-code-input"
            placeholder="Introduce tu c√≥digo"
            class="input flex-1"
          />
          <button id="apply-promo" class="btn btn-secondary">
            Aplicar
          </button>
        </div>
        <div id="promo-message" class="mt-2 text-sm"></div>
      </div>

      <!-- Resumen -->
      <div class="card bg-gray-50">
        <h3 class="font-bold text-xl mb-4">Resumen del Pedido</h3>
        <div class="space-y-2 mb-4">
          <div class="flex justify-between">
            <span>Subtotal:</span>
            <span id="subtotal">0‚Ç¨</span>
          </div>
          <div id="discount-row" class="hidden flex justify-between text-green-600">
            <span>Descuento (<span id="discount-percent"></span>):</span>
            <span id="discount-amount">0‚Ç¨</span>
          </div>
          <div class="border-t pt-2 flex justify-between text-xl font-bold">
            <span>Total:</span>
            <span id="total">0‚Ç¨</span>
          </div>
        </div>
        <button id="checkout-btn" class="btn btn-primary w-full">
          Proceder al Pago
        </button>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from '../lib/supabase';

    interface CartItem {
      product: any;
      quantity: number;
    }

    let appliedPromo: any = null;

    function renderCart() {
      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
      const cartItems = document.getElementById('cart-items');
      const emptyCart = document.getElementById('empty-cart');
      const cartContent = document.getElementById('cart-content');

      if (cart.length === 0) {
        emptyCart?.classList.remove('hidden');
        cartContent?.classList.add('hidden');
        return;
      }

      emptyCart?.classList.add('hidden');
      cartContent?.classList.remove('hidden');

      cartItems!.innerHTML = cart.map((item, index) => `
        <div class="card flex items-center gap-4">
          <img src="${item.product.image_url}" alt="${item.product.name}" class="w-24 h-24 object-cover rounded">
          <div class="flex-1">
            <h3 class="font-bold">${item.product.name}</h3>
            <p class="text-gray-600">${item.product.price}‚Ç¨</p>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn bg-gray-200 text-gray-800 px-3 py-1" data-index="${index}" data-action="decrease">
              -
            </button>
            <span class="w-12 text-center">${item.quantity}</span>
            <button class="btn bg-gray-200 text-gray-800 px-3 py-1" data-index="${index}" data-action="increase">
              +
            </button>
          </div>
          <div class="font-bold">
            ${(item.product.price * item.quantity).toFixed(2)}‚Ç¨
          </div>
          <button class="btn btn-danger px-3 py-1" data-index="${index}" data-action="remove">
            üóëÔ∏è
          </button>
        </div>
      `).join('');

      updateSummary();

      // Event listeners para botones
      document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const index = parseInt(target.dataset.index || '0');
          const action = target.dataset.action;
          
          handleCartAction(action!, index);
        });
      });
    }

    function handleCartAction(action: string, index: number) {
      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
      
      switch (action) {
        case 'increase':
          if (cart[index].quantity < cart[index].product.stock) {
            cart[index].quantity++;
          } else {
            alert('No hay suficiente stock disponible');
          }
          break;
        case 'decrease':
          if (cart[index].quantity > 1) {
            cart[index].quantity--;
          }
          break;
        case 'remove':
          cart.splice(index, 1);
          break;
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Actualizar contador del header
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartCount = document.getElementById('cart-count');
      if (cartCount) cartCount.textContent = count.toString();
      
      renderCart();
    }

    function updateSummary() {
      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
      const subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
      
      document.getElementById('subtotal')!.textContent = subtotal.toFixed(2) + '‚Ç¨';
      
      let total = subtotal;
      let discountAmount = 0;
      
      if (appliedPromo) {
        discountAmount = (subtotal * appliedPromo.discount_percentage) / 100;
        total = subtotal - discountAmount;
        
        document.getElementById('discount-row')?.classList.remove('hidden');
        document.getElementById('discount-percent')!.textContent = appliedPromo.discount_percentage + '%';
        document.getElementById('discount-amount')!.textContent = '-' + discountAmount.toFixed(2) + '‚Ç¨';
      } else {
        document.getElementById('discount-row')?.classList.add('hidden');
      }
      
      document.getElementById('total')!.textContent = total.toFixed(2) + '‚Ç¨';
    }

    // Aplicar c√≥digo promocional
    document.getElementById('apply-promo')?.addEventListener('click', async () => {
      const input = document.getElementById('promo-code-input') as HTMLInputElement;
      const code = input.value.trim().toUpperCase();
      const message = document.getElementById('promo-message');

      if (!code) {
        message!.textContent = 'Introduce un c√≥digo';
        message!.className = 'mt-2 text-sm text-red-600';
        return;
      }

      try {
        const { data, error } = await supabase
          .from('promo_codes')
          .select('*')
          .eq('code', code)
          .eq('active', true)
          .single();

        if (error || !data) {
          message!.textContent = 'C√≥digo inv√°lido o expirado';
          message!.className = 'mt-2 text-sm text-red-600';
          appliedPromo = null;
        } else {
          // Verificar fecha de expiraci√≥n
          if (data.expires_at && new Date(data.expires_at) < new Date()) {
            message!.textContent = 'El c√≥digo ha expirado';
            message!.className = 'mt-2 text-sm text-red-600';
            appliedPromo = null;
          } else {
            message!.textContent = `¬°C√≥digo aplicado! ${data.discount_percentage}% de descuento`;
            message!.className = 'mt-2 text-sm text-green-600';
            appliedPromo = data;
          }
        }

        updateSummary();
      } catch (error) {
        console.error('Error al verificar c√≥digo:', error);
      }
    });

    // Proceder al pago
    document.getElementById('checkout-btn')?.addEventListener('click', async () => {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        alert('Debes iniciar sesi√≥n para continuar');
        window.location.href = '/login';
        return;
      }

      const cart: CartItem[] = JSON.parse(localStorage.getItem('cart') || '[]');
      const subtotal = cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
      const discountAmount = appliedPromo ? (subtotal * appliedPromo.discount_percentage) / 100 : 0;
      const total = subtotal - discountAmount;

      try {
        const items = cart.map(item => ({
          product_id: item.product.id,
          quantity: item.quantity,
          price: item.product.price
        }));

        const response = await fetch('/api/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: session.user.id,
            items: items,
            total: total,
            promo_code: appliedPromo?.code || null,
            discount_amount: discountAmount
          })
        });

        const result = await response.json();

        if (response.ok) {
          // Limpiar carrito
          localStorage.removeItem('cart');
          alert('¬°Pedido realizado con √©xito!');
          window.location.href = '/mis-pedidos';
        } else {
          alert(result.error || 'Error al procesar el pedido');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al procesar el pedido');
      }
    });

    // Inicializar
    renderCart();
  </script>
</Layout>
