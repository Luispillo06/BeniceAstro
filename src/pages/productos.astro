---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';

// Obtener par√°metros de b√∫squeda
const url = new URL(Astro.request.url);
const animalType = url.searchParams.get('tipo');
const size = url.searchParams.get('tamano');
const category = url.searchParams.get('categoria');
const ageRange = url.searchParams.get('edad');

// Construir consulta con filtros
let query = supabase.from('products').select('*');

if (animalType) query = query.eq('animal_type', animalType);
if (size) query = query.eq('size', size);
if (category) query = query.eq('category', category);
if (ageRange) query = query.eq('age_range', ageRange);

const { data: products } = await query;
---

<Layout title="Productos">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-4xl font-bold mb-8">Cat√°logo de Productos</h1>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Filtros -->
      <div class="lg:col-span-1">
        <div class="card sticky top-4">
          <h2 class="text-xl font-bold mb-4">Filtros</h2>
          
          <form id="filter-form">
            <!-- Tipo de Animal -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Tipo de Animal</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="" checked class="mr-2">
                Todos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="perro" class="mr-2">
                üêï Perros
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="gato" class="mr-2">
                üêà Gatos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tipo" value="otros" class="mr-2">
                üêπ Otros
              </label>
            </div>

            <!-- Tama√±o -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Tama√±o</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="" checked class="mr-2">
                Todos
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="mini" class="mr-2">
                Mini
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="mediano" class="mr-2">
                Mediano
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="tamano" value="grande" class="mr-2">
                Grande
              </label>
            </div>

            <!-- Categor√≠a -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Categor√≠a</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="" checked class="mr-2">
                Todas
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="alimentacion" class="mr-2">
                Alimentaci√≥n
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="higiene" class="mr-2">
                Higiene
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="salud" class="mr-2">
                Salud
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="accesorios" class="mr-2">
                Accesorios
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="categoria" value="juguetes" class="mr-2">
                Juguetes
              </label>
            </div>

            <!-- Edad -->
            <div class="mb-6">
              <h3 class="font-semibold mb-2">Edad</h3>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="" checked class="mr-2">
                Todas
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="cachorro" class="mr-2">
                Cachorro/Joven
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="adulto" class="mr-2">
                Adulto
              </label>
              <label class="flex items-center mb-2">
                <input type="radio" name="edad" value="senior" class="mr-2">
                Senior
              </label>
            </div>

            <button type="button" id="apply-filters" class="btn btn-primary w-full">
              Aplicar Filtros
            </button>
          </form>
        </div>
      </div>

      <!-- Grid de Productos -->
      <div class="lg:col-span-3">
        <div class="mb-4 text-gray-600">
          {products && products.length > 0 ? `${products.length} productos encontrados` : 'No se encontraron productos'}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {products && products.map((product) => (
            <div class="card hover:shadow-xl transition-shadow">
              <img 
                src={product.image_url} 
                alt={product.name}
                class="w-full h-48 object-cover rounded-lg mb-4"
              />
              <h3 class="font-bold text-lg mb-2">{product.name}</h3>
              <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                {product.description}
              </p>
              <div class="flex items-center justify-between mb-4">
                <span class="text-2xl font-bold text-blue-600">
                  {product.price}‚Ç¨
                </span>
                <span class="text-sm text-gray-500">
                  Stock: {product.stock}
                </span>
              </div>
              <div class="flex gap-2 mb-4">
                <span class="badge bg-gray-100 text-gray-800 text-xs">
                  {product.animal_type}
                </span>
                <span class="badge bg-gray-100 text-gray-800 text-xs">
                  {product.category}
                </span>
              </div>
              <button 
                class="btn btn-primary w-full add-to-cart"
                data-product={JSON.stringify(product)}
              >
                A√±adir al Carrito
              </button>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

  <script>
    // Aplicar filtros
    const form = document.getElementById('filter-form');
    const applyButton = document.getElementById('apply-filters');

    // Cargar valores de filtro desde URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('tipo')) {
      (document.querySelector(`input[name="tipo"][value="${urlParams.get('tipo')}"]`) as HTMLInputElement)?.click();
    }
    if (urlParams.get('tamano')) {
      (document.querySelector(`input[name="tamano"][value="${urlParams.get('tamano')}"]`) as HTMLInputElement)?.click();
    }
    if (urlParams.get('categoria')) {
      (document.querySelector(`input[name="categoria"][value="${urlParams.get('categoria')}"]`) as HTMLInputElement)?.click();
    }
    if (urlParams.get('edad')) {
      (document.querySelector(`input[name="edad"][value="${urlParams.get('edad')}"]`) as HTMLInputElement)?.click();
    }

    applyButton?.addEventListener('click', () => {
      const formData = new FormData(form as HTMLFormElement);
      const params = new URLSearchParams();

      if (formData.get('tipo')) params.set('tipo', formData.get('tipo') as string);
      if (formData.get('tamano')) params.set('tamano', formData.get('tamano') as string);
      if (formData.get('categoria')) params.set('categoria', formData.get('categoria') as string);
      if (formData.get('edad')) params.set('edad', formData.get('edad') as string);

      window.location.href = `/productos?${params.toString()}`;
    });

    // A√±adir al carrito
    document.querySelectorAll('.add-to-cart').forEach(button => {
      button.addEventListener('click', (e) => {
        const product = JSON.parse((e.target as HTMLElement).dataset.product || '{}');
        
        // Obtener carrito actual
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        
        // Buscar si el producto ya est√° en el carrito
        const existingItem = cart.find((item: any) => item.product.id === product.id);
        
        if (existingItem) {
          existingItem.quantity += 1;
        } else {
          cart.push({ product, quantity: 1 });
        }
        
        // Guardar carrito
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Actualizar contador
        const cartCount = document.getElementById('cart-count');
        const count = cart.reduce((sum: number, item: any) => sum + item.quantity, 0);
        if (cartCount) cartCount.textContent = count.toString();
        
        // Feedback visual
        alert('Producto a√±adido al carrito');
      });
    });
  </script>
</Layout>
